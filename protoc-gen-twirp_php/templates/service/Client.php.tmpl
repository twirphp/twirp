<?php

// Generated by the protocol buffer compiler.  DO NOT EDIT! (protoc-gen-twirp_php {{ .Version }})
// source: {{ .File.Proto.Name }}

declare(strict_types=1);

namespace {{ .File | phpNamespace }};

use Google\Protobuf\Internal\GPBDecodeException;
use Google\Protobuf\Internal\Message;
use GuzzleHttp\Promise\Create;
use GuzzleHttp\Promise\PromiseInterface;

/**
 * A Protobuf client that implements the {@see {{ .Service | phpServiceName .File }}} interface.
 * It communicates using Protobuf and can be configured with a custom HTTP Client.
 *
 * Generated from protobuf service <code>{{ .Service.Desc.FullName }}</code>
 */
final class {{ .Service | phpServiceName .File }}Client extends {{ .Service | phpServiceName .File }}AbstractClient implements {{ .Service | phpServiceName .File }}
{
    protected function doRequest(array $ctx, string $url, Message $in, Message $out): void
    {
        $body = $in->serializeToString();

        $req = $this->newRequest($ctx, $url, $body, 'application/protobuf');

        try {
            $resp = $this->httpClient->sendRequest($req);
        } catch (\Throwable $e) {
            throw $this->clientError('failed to send request', $e);
        }

        if ($resp->getStatusCode() !== 200) {
            throw $this->errorFromResponse($resp);
        }

        try {
            $out->mergeFromString((string) $resp->getBody());
        } catch (GPBDecodeException $e) {
            throw $this->clientError('failed to unmarshal proto response', $e);
        }
    }

    /**
     * @inheritDoc
     */
    protected function doRequestAsync(array $ctx, string $url, Message $in, Message $out): PromiseInterface
    {
        // Check if the HTTP client supports async operations (e.g., Guzzle)
        if (!$this->supportsAsync()) {
            // Fallback: execute synchronously and return a resolved promise
            return Create::promiseFor($out)->then(function () use ($ctx, $url, $in, $out) {
                $this->doRequest($ctx, $url, $in, $out);
                return $out;
            });
        }

        $body = $in->serializeToString();
        $req = $this->newRequest($ctx, $url, $body, 'application/protobuf');

        // Send async request using Guzzle's sendAsync
        return $this->httpClient->sendAsync($req)->then(
            function ($resp) use ($out) {
                if ($resp->getStatusCode() !== 200) {
                    throw $this->errorFromResponse($resp);
                }

                try {
                    $out->mergeFromString((string)$resp->getBody());
                    return $out;
                } catch (GPBDecodeException $e) {
                    throw $this->clientError('failed to unmarshal proto response', $e);
                }
            },
            function ($e) {
                throw $this->clientError('failed to send request', $e);
            }
        );
    }
}
